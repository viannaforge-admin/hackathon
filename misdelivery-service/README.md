# Misdelivery Detection Service

Pre-send risk evaluation service that consumes existing `baseline.json` and checks likely misdelivery before send.

## Features

- Uses baseline schema exactly as generated by baseline builder
- Uses mock Graph API only for user directory loading (`/v1.0/users` with pagination)
- No DB; all data in memory
- Deterministic default time: `NOW = 2026-02-15T00:00:00Z` (unless request provides `now`)

## Endpoints

- `POST /v1/pre-send/check`
- `GET /v1/health`
- `POST /v1/baseline/reload`
- `POST /v1/users/reload`

## Environment

- `BASELINE_PATH` (default `./baseline.json`)
- `GRAPH_BASE_URL` (default `http://127.0.0.1:8000`)
- `USE_LLM_EXPLAINER` (`true` or `false`, default `false`)
- `LLM_EXPLAINER_URL` (default `http://127.0.0.1:8030`)

## Optional GenAI Explanations

- Decision and score are always deterministic rule outputs.
- LLM is used only to generate human-readable explanation text for `WARN`/`BLOCK`.
- For `ALLOW`, explanation is deterministic.
- If LLM service is unavailable, timeout occurs, or parsing fails, deterministic fallback explanation is used.
- Hard LLM timeout is `1.5s`.
- Privacy: message body and attachment contents are never sent to LLM; only structured metadata is sent.

## Run Locally

```bash
cd misdelivery-service
python3.11 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
uvicorn app.main:app --reload --port 8020
```

If baseline is generated in sibling folder:

```bash
BASELINE_PATH=../baseline-service/baseline.json uvicorn app.main:app --reload --port 8020
```

## Run With Docker Compose

From workspace root:

```bash
docker compose up --build
```

Misdelivery service URL:
- `http://127.0.0.1:8020`

## Example cURL (ALLOW)

```bash
curl -X POST "http://127.0.0.1:8020/v1/pre-send/check" \
  -H "Content-Type: application/json" \
  -d '{
    "senderUserId":"u001",
    "to":[{"userId":"u003","email":"neha.gupta@company.com"}],
    "cc":[],
    "bcc":[],
    "messageText":"Can we review the deployment plan?",
    "attachments":[]
  }'
```

## Example cURL (WARN: no baseline)

```bash
curl -X POST "http://127.0.0.1:8020/v1/pre-send/check" \
  -H "Content-Type: application/json" \
  -d '{
    "senderUserId":"u999",
    "to":[{"email":"new.user@company.com"}],
    "cc":[],
    "bcc":[],
    "messageText":"Quick follow up",
    "attachments":[]
  }'
```

## Example cURL (BLOCK likely confusion)

```bash
curl -X POST "http://127.0.0.1:8020/v1/pre-send/check" \
  -H "Content-Type: application/json" \
  -d '{
    "senderUserId":"u001",
    "to":[{"userId":"u002","email":"rahul.verma@company.com"}],
    "cc":[],
    "bcc":[{"userId":"u015","email":"rahul@vendor.com"}],
    "messageText":"Please review invoice and payroll payout details",
    "attachments":[{"name":"Payroll_Feb.xlsx","contentType":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","size":12345,"isLink":false}],
    "now":"2026-02-15T21:30:00Z"
  }'
```

## Reload Commands

```bash
curl -X POST "http://127.0.0.1:8020/v1/baseline/reload"
curl -X POST "http://127.0.0.1:8020/v1/users/reload"
```

## Tests

```bash
pytest -q
```
